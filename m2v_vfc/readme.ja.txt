【名称】

　MPEG-2 VIDEO VFAPI Plug-In

【機能】

　MPEG-1/MPEG-2 ファイル（M2V, M2P, VOB 等）の映像部分を VFAPI 対応
　アプリケーションソフトウェアで扱えるようにします

【著作権】

　Copyright (C) 2000-2005 MOGI, Kazuhrio（茂木 和洋）

【連絡先】

　kazhiro@marumo.ne.jp

【一次配布元】

　http://www.marumo.ne.jp/mpeg2/

【利用条件】

　このプログラムは MPEG-2 および VFAPI についての試験目的で作成された
　もので、様々な環境での動作確認を得るために WEB で公開しています。

　このプログラムを利用する場合以下の義務が発生します。

　・このプログラムを積極的に利用し、不具合の発見に努める。
　・不具合を発見した場合、作者と連絡を取り不具合の解消に協力する。
　・可能であればソースを解読し、より良い処理方法について提案を行う。

　また、以下の制限が加わります。

　・このプログラムの使用により何らかの損害が発生しても、作者に責任を
　　求めることはできない。

　以上の条件に従える方のみ利用ください。

【配布条件】

　オリジナルアーカイブと同じ構成での転載は、媒体・目的を問わず一切不
　許可とします。（本プログラムはあくまでも試験目的のものであるため）

【ソースコードの利用について】

　ソースを利用したことによって何らかの損害（例えば特許問題とか、プロ
　グラムのバグとか）が発生しても作者は何ら責任を負いません。

　以上の条件に従える方のみソースを利用ください。これ以外の制限はあり
　ません

【謝辞】

　このプログラムは

　・MSSG (MPEG Software Simulation Group) MPEG2DEC V1.2
　・IJG (Independent JPEG Group) jpeg 6b
　・Intel AP-922/AP-945
　・ITU-T H.222.0 2000(E) 
　・ITU-T H.262 2000(E)
　・ITU-R BT.601-5
　・ITU-R BT.709-5
　・ISO/IEC 11172-3 1993(E)
　・ARIB STD-B32 v1.2
　・藤原 洋 監修「最新 MPEG 教科書」（1994, ASCII）
　・インターフェース増刊 TECH I Vol.4「画像＆音声圧縮技術の全て」
　　（2000, CQ 出版）
　・小野定康・鈴木純司「わかりやすい JPEG/MPEG2 の技術」
　　（2001, オーム社）
　・藤原 洋/安田 浩 監修「標準 MPEG 教科書」（2003, ASCII）

　等を参考に記述しています。


【利用方法】

　アーカイブを展開し、トップフォルダにある

　・m2vconf.exe
　・m2v.vfp

　を同じフォルダに置き、m2vconf.exe を起動して決定を行えば、m2v.vfp 
　が VFAPI プラグインとして登録されます。

　後は、普通に VFAPI 対応アプリから M2V/M2P/VOB ファイルが扱えるよう
　になるはずです。

　src フォルダ以下のファイルはプラグインの利用には必要ありません。興
　味がなければ消してください。

　mme.exe も VFAPI プラグインの利用には必要ありません。興味がなけれ
　ば消してください。


【AviUtl 入力プラグイン】

　AviUtl 入力プラグインとして使用する場合、m2v.vfp を m2v.aui と
　リネームしてから AviUtl のプラグインフォルダにコピーしてください。

　m2v.aui は m2v.vfp と同じレジストリを参照するので、設定を変更する
　場合は m2vconf.exe を使用してください。

　この機能は 2ch avisynth を絶賛ιょぅょPART5 448 さんから提供された
　コードによって実現されています。

　AviUtl 入力プラグインとして使用する場合、出力フォーマットは YUY2
　になります。


【設定パラメータ】

　・アスペクト比

　　MPEG ファイル内のアスペクト比情報を使用して、表示サイズの補正を
　　行うかどうかを設定します

　　無視： アスペクト比の補正を行わない
　　反映： アスペクト比の補正を行う

　　初期値： 反映


　・フィールド順

　　出力画像のフィールドオーダを設定します
　　この機能はインタレース MPEG-2 ファイルでしか機能しません

　　ソースフレームを維持： MPEG ファイルのフィールドオーダーのまま
　　　　　　　　　　　　　 出力します
　　トップ→ボトムで出力： トップ→ボトム順に変換してから出力します
　　ボトム→トップで出力： ボトム→トップ順に変換してから出力します

　　初期値： トップ→ボトム順で出力


　・IDCT 関数

　　逆 DCT 関数のアルゴリズムを選択します

　　浮動小数点：   IEEE 1180 リファレンス アルゴリズムを使用します
　　整数(LLM)：    LLM アルゴリズムを使用します
　　整数(AP-922)： Intel AP-922 アルゴリズムを使用します

　　初期値： 整数（32bit AP-922）


　・CPU 拡張

　　各 CPU 拡張命令を使うかどうかを設定します

　　MMX:  ON (MMX 最適化命令を使う)
　　　　  OFF (MMX 最適化命令を使わない)
　　SSE:  ON (SSE 最適化命令を使う)
　　　　  OFF (SSE 最適化命令を使わない)
　　SSE2: ON (SSE2 最適化命令を使う)
　　　　  OFF (SSE2 最適化命令を使わない)

　　初期値： すべて OFF 


　・GOP リスト

　　シーク時に GOP タイムコードを使うか、また使わない（使えない）場
　　合に GL ファイルを作成するかどうかを設定します

　　・GOP タイムコードを使わない

　　　ON:  常に GOP リストを作成し、GOP タイムコードを使いません

　　　OFF: GOP タイムコードが信用できる場合は GOP タイムコードを使い、
　　　　　 明らかに GOP タイムコードが信用できない場合は GOP リストを
　　　　　 作成します

　　　初期値： OFF

　　・GL ファイルを作成しない

　　　ON:  GOP リストを作成した場合も、その結果を GL ファイルに保存
　　　　　 しません（ファイルを開くたびに毎回全ファイルを走査します）

　　　OFF: GOP リストを作成した場合、入力ファイルの拡張子を gl に変換
　　　　　 したファイルに GOP リストを出力します（同じファイルを開い
　　　　　 た時 GL ファイルが存在すればそちらから GOP リストを読み込
　　　　　 みます）

　　　初期値： OFF


　・連番ファイル

　　XXXX_000.mpg, XXXX_001.mpg 等の連番形式分割ファイルの扱い方を
　　設定します

　　結合して開く：　　　　 連番ファイルの残りを自動的に結合して読み
　　　　　　　　　　　　　 込みます

　　指定ファイルのみ開く： 指定されたファイル以外は開きません

　　初期値： 指定ファイルのみ開く


　・YUV -> RGB 変換

　　YUV -> RGB 変換の形式を設定します

　　ストレート変換：        YUV [0:255] を RGB [0:255] に変換します
　　ITU-R BT.601 から伸張： Y [16-235] UV [16-240] を RGB [0:255] に
　　　　　　　　　　　　　　変換します 

　　初期値： ITU-R BT.601 から伸張


　・色空間行列（省略時）

　　MPEG-2 ファイルで matrix_coefficient 情報が存在しない場合の YUV
　　RGB 変換行列を選択します

　　自動認識： 720x480@30Hz か 720x576@25Hz 以下の場合に SMPTE 170M
　　　　　　　 に設定し、それ以上の場合は ITU-R BT.709 に設定します

　　それ以外： 指定された YUV RGB 変換行列に固定します

　　初期値： 自動認識


　・YUY2 色空間行列 (m2v.aui 用)

　　AviUtl 入力プラグインとして利用した場合に出力される YUY2 データ
　　形式を指定します

　　元の YUV データを維持： YUV データに手を加えずに出力します

　　それ以外： matrix_coefficient の色空間から、指定された色空間に
　　　　　　　 変換します
　　　　　　　 双方が一致している場合は、変換せずに出力します
　　
　　初期値： 元データを維持


【バグ】

　・スケーラビリティについては、全て非対応

　・mme.exe で「編集 -> やりなおし」メニューが常に選択不能

　・mme.exe で「ヘルプ -> MME について」メニューが常に選択不能

　・mme.exe で TS の出力ができない

　・mme.exe で出力した PS/SS で音と映像の長さがあわない

　・MPEG-1 Audio Layer-2 しか音声がデコードできない


【その他】

　・デコード速度を向上させたい場合、以下の設定を試してみてください。

　　- アスペクト比「無視」
　　- IDCT 関数「整数(32bit AP-922)」
　　- CPU 拡張に全てチェック

　・シーケンスエンドコードで終端されてないストリームでは、フレーム数
　　を２つ減らすようにしています。

　　数時間掛けたエンコードの最後で落ちるよりもマシだと思うのですけど、
　　異論がある方はよりよい処理方法でも提案してください。

　　確かに、シーケンスエンドコードが無い事と最後の B ピクチャデータが
　　不完全なことは論理的には関連性がないですけど、最後の B ピクチャが
　　途中で欠けてる場合、シーケンスエンドコードも無い事が多いので。

　　ピクチャデータが完全か真面目に検証するより、シーケンスエンドコー
　　ドがあるかないかだけを調べた方が楽だと思いません？

　・YUV -> RGB 変換式

　　以下の変換式を使用してます。おかしな点があったら指摘してください。

　　MPEG-1 の場合（伸張）
　　　R = (76309 * (Y-16)                    + 104597 * (V-128)) / 65536
　　　G = (76309 * (Y-16) -  25675 * (U-128) -  53279 * (V-128)) / 65536
　　　B = (76308 * (Y-16) + 132201 * (U-128)                   ) / 65536

　　MPEG-1 の場合（ストレート）
　　　R = (65536 *  Y                        +  91881 * (V-128)) / 65536
　　　G = (65536 *  Y     -  22553 * (U-128) -  46801 * (V-128)) / 65536
　　　B = (65536 *  Y     + 116129 * (U-128)                   ) / 65536

　　MPEG-2 sequence_display_extension ありの場合

　　　matrix_coefficient=1 - ITU-R BT.709（伸張）
　　　　R = (76309 * (Y-16)                    + 117504 * (V-128)) / 65536
　　　　G = (76309 * (Y-16) -  13954 * (U-128) -  34903 * (V-128)) / 65536
　　　　B = (76308 * (Y-16) + 138453 * (U-128)                   ) / 65536

　　　matrix_coefficient=1 - ITU-R BT.709（ストレート）
　　　　R = (65536 *  Y                        + 103219 * (V-128)) / 65536
　　　　G = (65536 *  Y     -  12257 * (U-128) -  30659 * (V-128)) / 65536
　　　　B = (65536 *  Y     + 121621 * (U-128)                   ) / 65536

　　　matrix_coefficient=4 - FCC（伸張）
　　　　R = (76309 * (Y-16)                    + 104597 * (V-128)) / 65536
　　　　G = (76309 * (Y-16) -  25675 * (U-128) -  53279 * (V-128)) / 65536
　　　　B = (76308 * (Y-16) + 132201 * (U-128)                   ) / 65536

　　　matrix_coefficient=4 - FCC（ストレート）
　　　　R = (65536 *  Y                        + 104448 * (V-128)) / 65536
　　　　G = (65536 *  Y     -  22553 * (U-128) -  46801 * (V-128)) / 65536
　　　　B = (65536 *  Y     + 116129 * (U-128)                   ) / 65536

　　　matrix_coefficient=5 ITU-R Rec. 470-2 System B, G
　　　　MPEG-1 の場合と同じ

　　　matrix_coefficient=6 SMPTE 170M
　　　　MPEG-1 の場合と同じ

　　　matrix_coefficient=7 - SMPTE 240M（伸張）
　　　　R = (76309 * (Y-16)                    + 117579 * (V-128)) / 65536
　　　　G = (76309 * (Y-16) -  16907 * (U-128) -  35559 * (V-128)) / 65536
　　　　B = (76308 * (Y-16) + 136230 * (U-128)                   ) / 65536

　　　matrix_coefficient=7 - SMPTE 240M（ストレート）
　　　　R = (65536 *  Y                        + 103284 * (V-128)) / 65536
　　　　G = (65536 *  Y     -  14851 * (U-128) -  31235 * (V-128)) / 65536
　　　　B = (65536 *  Y     + 119668 * (U-128)                   ) / 65536

